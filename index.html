<!DOCTYPE html>
<html>

  <head>
    <title>NYPD Shooting Incident Data</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.1.8/carto.min.js"></script>
    <!-- Include D3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
    
    <link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet">
  </head>

  <body>
    <div id="map"></div>
    <aside class="toolbox">
      <div class="box">
        <header>
          <h1>NYPD Shooting Incident Data
</h1>

        </header>
        <section>
          
          <div class="separator"></div>
          <section class="usage">
            <header>USAGE</header>
            <p class="open-sans">Select different year</p>
          </section>

          <div id="controls">
            <ul>
              <li onclick="setAllDatas()">
                <input type="radio" name="source" checked id="all">
                <label for="all">All Datas</label>
              </li>
              <li onclick="set2017()">
                <input type="radio" name="source" id="2017">
                <label for="2017">2017</label>
              </li>
              <li onclick="set2016()">
                <input type="radio" name="source" id="2016">
                <label for="2016">2016</label>
              </li>
              <li onclick="set2015()">
                <input type="radio" name="source" id="2015">
                <label for="2015">2015</label>
              </li>
              <li onclick="set2014()">
                <input type="radio" name="source" id="2014">
                <label for="2014">2014</label>
              </li>
              <li onclick="set2013()">
                <input type="radio" name="source" id="2013">
                <label for="2013">2013</label>
 <!-- <li> list of item -->
            </ul>
          </div>
        </section>
        <div id="controls">
            <h2 class="h2">Police Precinct</h2>
            <select class="js-precincts">
              <option value="">All</option>
            </select>
            <div id="info"></div>
          </div>
        <div id="controls">
            <h2 class="h3">Boro</h2>
            <select class="js-boros">
              <option value="">All</option>
            </select>
            <div id="info"></div>
          </div>
        <footer class="js-footer"></footer>

      </div>
    </aside>
    
    <script>
  
      
          
      
let center = [40.7, -73.975],
  cusp = [40.692908, -73.9896452];

const map = L.map('map', {
  center: center,
  zoom: 13
});
map.scrollWheelZoom.disable();

L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

const client = new carto.Client({
  apiKey: '689d9652bc9b03cc4258c15ff1a1579ed0f6ea33',
  username: 'hanyuatwork'
});
      
     
const source = new carto.source.SQL('SELECT * FROM nypd_shooting_incident_data');
const style = new carto.style.CartoCSS(`
        #layer {
          marker-width: 7;
          marker-fill: '#EE4D5A';
          marker-line-color: #FFFFFF;
        }
      `);
      

const layer = new carto.layer.Layer(source, style, {
  featureOverColumns: ['occur_date', 'vic_sex', 'vic_race', 'precinct']
});

client.addLayer(layer);
client.getLeafletLayer().addTo(map);
      

      
const popup = L.popup({
  closeButton: false
});
      
function openPopup(featureEvent) {
  let content = '<div class="widget">';

  content += `
<h2 class="h2">${'occur_data:'}</h2>
<h2 class="h2">${featureEvent.data.occur_date}</h2>
<h2 class="h2">${'vic_sex:'}</h2>
<h2 class="h2">${featureEvent.data.vic_sex}</h2> 
<h2 class="h2">${'vic_race:'}</h2>
<h2 class="h2">${featureEvent.data.vic_race}</h2> 
<h2 class="h2">${'Police precinct:'}</h2>
<h2 class="h2">${featureEvent.data.precinct}</h2>`;

  content += `</div>`;

  popup.setContent(content);
  popup.setLatLng(featureEvent.latLng);
  if (!popup.isOpen()) {
    popup.openOn(map);
  }
}

function closePopup(featureEvent) {
  popup.removeFrom(map);
}

layer.on('featureClicked', openPopup);



function setAllDatas() {
  source.setQuery('SELECT * FROM nypd_shooting_incident_data');
 
}

function set2017() {
  source.setQuery(`
         SELECT * FROM nypd_shooting_incident_data where cartodb_id <= '969'
        `);
}
function set2016() {
  source.setQuery(`
         SELECT * FROM nypd_shooting_incident_data where cartodb_id > '969' and cartodb_id <= '2175'
        `);
  
}
function set2015() {
  source.setQuery(`
          SELECT * FROM nypd_shooting_incident_data where cartodb_id > '2175' and cartodb_id <= '3609'
        `);
}
function set2014() {
  source.setQuery(`
        SELECT * FROM nypd_shooting_incident_data where cartodb_id > '3609' and cartodb_id <= '5068'
        `);
}
function set2013() {
  source.setQuery(`
       SELECT * FROM nypd_shooting_incident_data where cartodb_id > '6068' 
        `);
}
      
      
       const PrecinctDataview = new carto.dataview.Category(source, 'precinct', {
        limit: 100
      });

      function compareNumbers(a, b)
        {
            return a - b;
        }
      
      PrecinctDataview.on('dataChanged', data => {
        const precinct = data.categories.map(d => d.name).sort(compareNumbers);
        refreshWidget(precinct);
      });

      function refreshWidget(adminNames) {
        const asideElement = document.querySelector('aside.toolbox');
        const precinctsDom = asideElement.querySelector('.js-precincts');
        precinctsDom.onchange = event => {
          const admin = event.target.value;
          highlightPrecinct(admin);
          
        };

        adminNames.forEach(admin => {
          const option = document.createElement('option');
          option.innerHTML = admin;
          option.value = admin;
          precinctsDom.appendChild(option);
        });
      }

      function highlightPrecinct(admin) {
        source.setQuery(`
          SELECT * FROM nypd_shooting_incident_data where precinct = ${admin}
        `);
      }

      
      client.addDataview(PrecinctDataview);
      
      
//-------------------------------
      const BorosDataview = new carto.dataview.Category(source, 'boro', {
        limit: 100
      });

      BorosDataview.on('dataChanged', data => {
        const boro = data.categories.map(d => d.name);
        refreshWidget1(boro);
      });

      function refreshWidget1(adminNames) {
        const asideElement = document.querySelector('aside.toolbox');
        const borosDom = asideElement.querySelector('.js-boros');
        borosDom.onchange = event => {
          const admin = event.target.value;
          highlightBoro(admin);
        };

        adminNames.forEach(admin => {
          const option = document.createElement('option');
          option.innerHTML = admin;
          option.value = admin;
          borosDom.appendChild(option);
        });
      }

      function highlightBoro(admin) {
        source.setQuery(`
          SELECT * FROM nypd_shooting_incident_data where boro = '${admin}'
        `);
      }

      
      client.addDataview(BorosDataview);
      
    </script>

  </body>

</html>

