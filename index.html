<!DOCTYPE html>
<html>

  <head>
    <title>Change source | CARTO</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.1.8/carto.min.js"></script>
    <link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet">
  </head>

  <body>
    <div id="map"></div>
    <aside class="toolbox">
      <div class="box">
        <header>
          <h1>Change the source</h1>
          <button class="github-logo js-source-link"></button>
        </header>
        <section>
          <p class="description open-sans">Update the source of your layers.</p>
          <div class="separator"></div>
          <section class="usage">
            <header>USAGE</header>
            <p class="open-sans">Select different sources</p>
          </section>

          <div id="controls">
            <ul>
              <li onclick="setAllCities()">
                <input type="radio" name="source" checked id="all">
                <label for="all">All cities</label>
              </li>
              <li onclick="setEuropeanCities()">
                <input type="radio" name="source" id="europe">
                <label for="europe">European cities</label>
              </li>
              <li onclick="setSpanishCities()">
                <input type="radio" name="source" id="spain">
                <label for="spain">Spanish cities</label>
              </li>
            </ul>
          </div>

        </section>
        <footer class="js-footer"></footer>
      </div>
    </aside>
    <script>
    let center = [40.7, -73.975],
  cusp = [40.692908, -73.9896452];

const map = L.map('map', {
  center: center,
  zoom: 12
});
map.scrollWheelZoom.disable();

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
  maxZoom: 18
}).addTo(map);

const client = new carto.Client({
  apiKey: '689d9652bc9b03cc4258c15ff1a1579ed0f6ea33',
  username: 'hanyuatwork'
});

const source = new carto.source.SQL('SELECT * FROM nypd_shooting_incident_data');
const style = new carto.style.CartoCSS(`
        #layer {
          marker-width: 7;
          marker-fill: #EE4D5A;
          marker-line-color: #FFFFFF;
        }
      `);
const layer = new carto.layer.Layer(source, style, {
  featureOverColumns: ['occur_date', 'vic_sex', 'vic_race', 'precinct']
});

client.addLayer(layer);
client.getLeafletLayer().addTo(map);



const popup = L.popup({
  closeButton: false
});

function openPopup(featureEvent) {
  let content = '<div class="widget">';

  content += `
<h2 class="h2">${'occur_data:'}</h2>
<h2 class="h2">${featureEvent.data.occur_date}</h2>
<h2 class="h2">${'vic_sex:'}</h2>
<h2 class="h2">${featureEvent.data.vic_sex}</h2> 
<h2 class="h2">${'vic_race:'}</h2>
<h2 class="h2">${featureEvent.data.vic_race}</h2> 
<h2 class="h2">${'Police precinct:'}</h2>
<h2 class="h2">${featureEvent.data.precinct}</h2>`;

  content += `</div>`;

  popup.setContent(content);
  popup.setLatLng(featureEvent.latLng);
  if (!popup.isOpen()) {
    popup.openOn(map);
  }
}

function closePopup(featureEvent) {
  popup.removeFrom(map);
}

layer.on('featureClicked', openPopup);



function setAllCities() {
  source.setQuery('SELECT * FROM ne_10m_populated_places_simple');
}

function setEuropeanCities() {
  source.setQuery(`
          SELECT *
            FROM ne_10m_populated_places_simple
            WHERE adm0name IN (SELECT admin FROM ne_adm0_europe)
        `);
}

function setSpanishCities() {
  source.setQuery(`
          SELECT *
            FROM ne_10m_populated_places_simple
            WHERE adm0name = \'Spain\'
        `);
}

    </script>

  </body>

</html>
